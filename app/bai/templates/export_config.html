{% extends "base.html" %}

{% block title %}Export Configuration - BAI Monitor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-gear"></i> Export Configuration</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addConfigModal">
                <i class="bi bi-plus-circle"></i> Add New Export
            </button>
        </div>

        <!-- Export Config Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-table"></i> Export Configurations</h5>
            </div>
            <div class="card-body">
                {% if configs %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Status</th>
                                <th>Bank</th>
                                <th>IBAN</th>
                                <th>Format</th>
                                <th>Version</th>
                                <th>Destination</th>
                                <th>Output Path</th>
                                <th>File Settings</th>
                                <th>Date Settings</th>
                                <th>Created</th>
                                <th>Info</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for config in configs %}
                            <tr>
                                <td>{{ config.id }}</td>
                                <td>
                                    {% if config.enabled %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle"></i> Enabled
                                    </span>
                                    {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="bi bi-pause-circle"></i> Disabled
                                    </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ config.bank|default('-') }}</span>
                                </td>
                                <td>
                                    <code>{{ config.iban|default('-') }}</code>
                                </td>
                                <td>{{ config.exportformat|default('-') }}</td>
                                <td>
                                    <small class="text-muted">{{ config.exportformatversion|default('-') }}</small>
                                </td>
                                <td>{{ config.destination|default('-') }}</td>
                                <td>
                                    <small class="font-monospace text-muted">{{ config.outputpath|default('-') }}</small>
                                </td>
                                <td>
                                    <small>
                                        <strong>Prefix:</strong> {{ config.fileprefix|default('-') }}<br>
                                        <strong>Ext:</strong> {{ config.fileextension|default('-') }}
                                    </small>
                                </td>
                                <td>
                                    {% if config.includedate %}
                                    <span class="badge bg-primary">
                                        <i class="bi bi-calendar-check"></i> {{ config.dateformat|default('YYYYMMDD') }}
                                    </span>
                                    {% else %}
                                    <span class="text-muted">No date</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ config.createdat.strftime('%Y-%m-%d') if config.createdat else '-' }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editModal{{ config.id }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-info" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#detailModal{{ config.id }}">
                                            <i class="bi bi-info-circle"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Edit Modal -->
                                    <div class="modal fade" id="editModal{{ config.id }}" tabindex="-1">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <form method="post" action="{{ url_for('bai.export_config') }}">
                                                    <input type="hidden" name="action" value="update">
                                                    <input type="hidden" name="id" value="{{ config.id }}">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">
                                                            <i class="bi bi-pencil"></i> Edit Export Configuration
                                                        </h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="alert alert-info">
                                                            <strong>Read-only:</strong> Bank, IBAN, Format, and Destination cannot be changed.
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <div class="mb-3">
                                                                    <label class="form-label">Bank</label>
                                                                    <input type="text" class="form-control" value="{{ config.bank }}" disabled>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label class="form-label">IBAN</label>
                                                                    <input type="text" class="form-control" value="{{ config.iban }}" disabled>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label class="form-label">Export Format</label>
                                                                    <input type="text" class="form-control" value="{{ config.exportformat }}" disabled>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label class="form-label">Format Version</label>
                                                                    <input type="text" class="form-control" name="exportformatversion" 
                                                                           value="{{ config.exportformatversion|default('') }}" placeholder="e.g., 1.0, 2.1">
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <div class="mb-3">
                                                                    <label class="form-label">Destination</label>
                                                                    <input type="text" class="form-control" value="{{ config.destination }}" disabled>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label class="form-label">Output Path *</label>
                                                                    <input type="text" class="form-control" name="outputpath" required 
                                                                           value="{{ config.outputpath }}" placeholder="C:\Exports\ or /exports/">
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label class="form-label">File Prefix</label>
                                                                    <input type="text" class="form-control" name="fileprefix" 
                                                                           value="{{ config.fileprefix|default('') }}" placeholder="e.g., BAI_EXPORT_">
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label class="form-label">File Extension *</label>
                                                                    <input type="text" class="form-control" name="fileextension" required 
                                                                           value="{{ config.fileextension }}" placeholder=".xml, .txt">
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <hr>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <div class="mb-3">
                                                                    <div class="form-check form-switch">
                                                                        <input class="form-check-input" type="checkbox" name="includedate" 
                                                                               id="includedate{{ config.id }}" {{ 'checked' if config.includedate else '' }}>
                                                                        <label class="form-check-label" for="includedate{{ config.id }}">Include Date in Filename</label>
                                                                    </div>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label class="form-label">Date Format</label>
                                                                    <input type="text" class="form-control" name="dateformat" 
                                                                           value="{{ config.dateformat|default('YYYYMMDD') }}" placeholder="YYYYMMDD">
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <div class="mb-3">
                                                                    <div class="form-check form-switch">
                                                                        <input class="form-check-input" type="checkbox" name="enabled" 
                                                                               id="enabled{{ config.id }}" {{ 'checked' if config.enabled else '' }}>
                                                                        <label class="form-check-label" for="enabled{{ config.id }}">Enabled</label>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-primary">
                                                            <i class="bi bi-save"></i> Save Changes
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Detail Modal -->
                                    <div class="modal fade" id="detailModal{{ config.id }}" tabindex="-1">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">
                                                        <i class="bi bi-info-circle"></i> Export Configuration Details
                                                    </h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <p><strong>ID:</strong> {{ config.id }}</p>
                                                            <p><strong>Status:</strong> 
                                                                {% if config.enabled %}
                                                                <span class="badge bg-success">Enabled</span>
                                                                {% else %}
                                                                <span class="badge bg-secondary">Disabled</span>
                                                                {% endif %}
                                                            </p>
                                                            <p><strong>Bank:</strong> {{ config.bank }}</p>
                                                            <p><strong>IBAN:</strong> {{ config.iban }}</p>
                                                            <p><strong>Export Format:</strong> {{ config.exportformat }}</p>
                                                            <p><strong>Format Version:</strong> {{ config.exportformatversion|default('N/A') }}</p>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <p><strong>Destination:</strong> {{ config.destination }}</p>
                                                            <p><strong>Output Path:</strong><br>
                                                                <code class="d-block bg-light p-2 rounded">{{ config.outputpath }}</code>
                                                            </p>
                                                            <p><strong>File Prefix:</strong> {{ config.fileprefix|default('N/A') }}</p>
                                                            <p><strong>File Extension:</strong> {{ config.fileextension|default('N/A') }}</p>
                                                            <p><strong>Include Date:</strong> {{ 'Yes' if config.includedate else 'No' }}</p>
                                                            <p><strong>Date Format:</strong> {{ config.dateformat|default('N/A') }}</p>
                                                        </div>
                                                    </div>
                                                    <hr>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <p><strong>Created:</strong> {{ config.createdat.strftime('%Y-%m-%d %H:%M:%S') if config.createdat else 'N/A' }}</p>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <p><strong>Updated:</strong> {{ config.updatedat.strftime('%Y-%m-%d %H:%M:%S') if config.updatedat else 'N/A' }}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No export configurations found. Click "Add New Export" to create one.
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Info Card -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> About Export Configurations</h5>
            </div>
            <div class="card-body">
                <p>Export configurations define how transaction data is exported from the BAI system.</p>
                <p><strong>Export Formats:</strong></p>
                <ul>
                    <li><strong>CAMT053:</strong> ISO 20022 XML bank statement format (Cash Management)</li>
                    <li><strong>MT940:</strong> SWIFT MT940 customer statement format</li>
                </ul>
                <p><strong>Destinations:</strong></p>
                <ul>
                    <li><strong>Autobank:</strong> Export to Autobank system</li>
                    <li><strong>Globes:</strong> Export to Globes ERP system</li>
                </ul>
                <p class="mb-0"><em>Note: Exports are triggered and scheduled externally (e.g., via UiPath). The frontend only manages configuration.</em></p>
            </div>
        </div>
    </div>
</div>

<!-- Add Config Modal -->
<div class="modal fade" id="addConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="{{ url_for('bai.export_config') }}">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle"></i> Add New Export Configuration
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Bank *</label>
                                <input type="text" class="form-control" name="bank" required 
                                       placeholder="Rabobank" list="bankList">
                                <datalist id="bankList">
                                    {% for bank in banks %}
                                    <option value="{{ bank }}">
                                    {% endfor %}
                                </datalist>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">IBAN *</label>
                                <input type="text" class="form-control" name="iban" required 
                                       placeholder="NL00BANK0123456789" list="ibanList">
                                <datalist id="ibanList">
                                    {% for iban in ibans %}
                                    <option value="{{ iban }}">
                                    {% endfor %}
                                </datalist>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Export Format *</label>
                                <select name="exportformat" class="form-select" required>
                                    <option value="">Select format...</option>
                                    <option value="CAMT053">CAMT053</option>
                                    <option value="MT940">MT940</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Format Version</label>
                                <input type="text" class="form-control" name="exportformatversion" 
                                       placeholder="e.g., 1.0, 2.1">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Destination *</label>
                                <select name="destination" class="form-select" required>
                                    <option value="">Select destination...</option>
                                    <option value="Autobank">Autobank</option>
                                    <option value="Globes">Globes</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Output Path *</label>
                                <input type="text" class="form-control" name="outputpath" required 
                                       placeholder="C:\Exports\ or /exports/">
                                <small class="form-text text-muted">Full path where files will be saved</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">File Prefix</label>
                                <input type="text" class="form-control" name="fileprefix" 
                                       placeholder="e.g., BAI_EXPORT_">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">File Extension *</label>
                                <input type="text" class="form-control" name="fileextension" required 
                                       placeholder=".csv, .xml, .txt" value=".csv">
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="includedate" id="includedate">
                                    <label class="form-check-label" for="includedate">Include Date in Filename</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Date Format</label>
                                <input type="text" class="form-control" name="dateformat" 
                                       placeholder="YYYYMMDD" value="YYYYMMDD">
                                <small class="form-text text-muted">Format for date in filename</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="enabled" id="enabled" checked>
                                    <label class="form-check-label" for="enabled">Enabled</label>
                                </div>
                                <small class="form-text text-muted">Enable this export configuration</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Create Export
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}
