-- Integrated query: haalt transactions op voor alle accounts op een specifieke datum
-- Gebaseerd op de balance data, geen handmatige TX_AUDIT_ID nodig
WITH params AS (
  -- Vul hier de gewenste datum in
  SELECT
    DATE '[CLOSINGDATE]'        AS target_date,               -- precieze datum
    ARRAY[]::text[] AS ibans           -- empty= all IBANs
),
range AS (
  -- Gebruik target_date als zowel start als end (één dag)
  SELECT
    (SELECT target_date FROM params) AS start_date,
    (SELECT target_date FROM params) AS end_date
),
-- IBANs in scope: uit balances (er is altijd closingBooked)
ib_all AS (
  SELECT DISTINCT b.iban
  FROM bai_rabobank_balances b
  CROSS JOIN params p
  WHERE b.balance_type = 'closingBooked'
    AND b.reference_date BETWEEN (SELECT start_date FROM range) - INTERVAL '1 day' AND (SELECT end_date FROM range)
    AND (
      (SELECT cardinality(p.ibans)) = 0
      OR b.iban IN (SELECT unnest(p.ibans))
    )
),
-- Transactions per dag (incl. audit_id op regelniveau)
numeric_transactions AS (
  SELECT
    t.iban,
    DATE(t.rabo_booking_datetime AT TIME ZONE 'Europe/Amsterdam') AS booking_date,
    t.audit_id AS tx_audit_id,
    (t.rabo_booking_datetime AT TIME ZONE 'Europe/Amsterdam') AS tx_book_dt_local,
    CASE
      WHEN t.transaction_amount IS NULL THEN 0::numeric
      WHEN replace(t.transaction_amount::text, '"', '') ~ '^[+-]?[0-9]+(\.[0-9]+)?$'
        THEN (replace(t.transaction_amount::text, '"', ''))::numeric
      WHEN replace(t.transaction_amount::text, '"', '') ~ '^[+-]?[0-9]+(,[0-9]+)?$'
        THEN replace(replace(t.transaction_amount::text, '"', ''), ',', '.')::numeric
      WHEN replace(t.transaction_amount::text, '"', '') ~ '^[+-]?[0-9]{1,3}(\.[0-9]{3})+,[0-9]{2}$'
        THEN replace(replace(replace(t.transaction_amount::text, '"', ''), '.', ''), ',', '.')::numeric
      WHEN replace(t.transaction_amount::text, '"', '') ~ '^[+-]?[0-9]{1,3}(,[0-9]{3})+\.[0-9]{2}$'
        THEN replace(replace(t.transaction_amount::text, '"', ''), ',', '')::numeric
      ELSE 0::numeric
    END AS amount_numeric
  FROM bai_rabobank_transactions t
  CROSS JOIN range r
  CROSS JOIN params p
  WHERE (
      (SELECT cardinality(p.ibans)) = 0
      OR t.iban IN (SELECT unnest(p.ibans))
    )
    AND DATE(t.rabo_booking_datetime AT TIME ZONE 'Europe/Amsterdam')
        BETWEEN r.start_date AND r.end_date
),
-- Verzamel alle relevante audit_ids per IBAN/dag
relevant_audit_ids AS (
  SELECT
    iban,
    booking_date,
    array_agg(DISTINCT tx_audit_id) AS tx_audit_ids
  FROM numeric_transactions
  GROUP BY iban, booking_date
)
-- Haal alle transactions op voor de relevante audit_ids
SELECT t.*
FROM bai_rabobank_transactions t
INNER JOIN relevant_audit_ids ra 
  ON t.iban = ra.iban
  AND t.audit_id = ANY(ra.tx_audit_ids)
ORDER BY t.iban, t.rabo_booking_datetime;
