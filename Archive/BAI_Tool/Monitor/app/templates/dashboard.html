{% extends "base.html" %}

{% block title %}Dashboard - BAI Monitor{% endblock %}

{% block content %}
<h2 class="mb-4">
    <i class="bi bi-speedometer2"></i> Dashboard
    <small class="text-muted">{{ current_date.strftime('%d-%m-%Y %H:%M') }}</small>
</h2>

<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-12 mb-2">
                <label class="form-label fw-bold">Period selection:</label>
                <div class="btn-group" role="group">
                    <button type="submit" name="days" value="1" class="btn btn-sm {% if selected_days == 1 %}btn-primary{% else %}btn-outline-primary{% endif %}">1 day</button>
                    <button type="submit" name="days" value="7" class="btn btn-sm {% if selected_days == 7 %}btn-primary{% else %}btn-outline-primary{% endif %}">7 days</button>
                    <button type="submit" name="days" value="14" class="btn btn-sm {% if selected_days == 14 %}btn-primary{% else %}btn-outline-primary{% endif %}">14 days</button>
                    <button type="submit" name="days" value="30" class="btn btn-sm {% if selected_days == 30 %}btn-primary{% else %}btn-outline-primary{% endif %}">30 days</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="row mb-4">
    <!-- Summary Cards -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center p-3 bg-info bg-opacity-10 rounded">
                <div class="text-muted small">Transactions ({{ selected_days }}d)</div>
                <div class="h2 mb-0">{{ transaction_summary|sum(attribute='transaction_count') }}</div>
                <small class="text-muted">Last {{ selected_days }} day{% if selected_days != 1 %}s{% endif %}</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        {% set ok_count = data_quality|selectattr('overall_status', 'equalto', 'OK')|list|length %}
        {% set all_ok = ok_count == data_quality|length and data_quality|length > 0 %}
        <div class="card">
            <div class="card-body text-center p-3 {% if all_ok %}bg-success{% else %}bg-danger{% endif %} bg-opacity-10 rounded">
                <div class="text-muted small">Data Quality</div>
                <div class="h2 mb-0 {% if all_ok %}text-success{% else %}text-danger{% endif %}">
                    {{ ok_count }}/{{ data_quality|length }}
                </div>
                <small class="text-muted">Day/IBAN OK</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        {% set no_missing = missing_days|length == 0 %}
        <div class="card">
            <div class="card-body text-center p-3 {% if no_missing %}bg-success{% else %}bg-danger{% endif %} bg-opacity-10 rounded">
                <div class="text-muted small">Missing Days</div>
                <div class="h2 mb-0 {% if no_missing %}text-success{% else %}text-danger{% endif %}">{{ missing_days|length }}</div>
                <small class="text-muted">Days without data</small>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-graph-up"></i> Transaction Count per Day ({{ selected_days }} days)</h5>
            </div>
            <div class="card-body">
                <canvas id="transactionChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-check-circle"></i> Data Quality Status ({{ selected_days }} days)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>IBAN</th>
                                <th class="text-center">Overall Status</th>
                                <th class="text-center">Balance OK/NOK</th>
                                <th class="text-center">Transactions OK/NOK</th>
                                <th class="text-center">TX Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if not data_quality %}
                            <tr>
                                <td colspan="6" class="text-center text-muted">No data available</td>
                            </tr>
                            {% endif %}
                            {% for row in data_quality %}
                            <tr class="{% if row.overall_status != 'OK' %}table-warning{% endif %}">
                                <td>{{ row.date.strftime('%d-%m-%Y') if row.date else '-' }}</td>
                                <td><code>{{ row.iban }}</code></td>
                                <td class="text-center">
                                    {% if row.overall_status == 'OK' %}
                                    <span class="badge bg-success">OK</span>
                                    {% else %}
                                    <span class="badge bg-danger">NOK</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if row.balance_status == 'OK' %}
                                    <span class="badge bg-success">OK</span>
                                    {% else %}
                                    <span class="badge bg-danger">NOK</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if row.transaction_status == 'OK' %}
                                    <span class="badge bg-success">OK</span>
                                    {% else %}
                                    <span class="badge bg-danger">NOK</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-primary">{{ row.tx_count }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% if missing_days %}
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-white">
                <h5><i class="bi bi-exclamation-triangle"></i> Missing Data Days</h5>
            </div>
            <div class="card-body">
                <p>The following business days have no transactions in the database:</p>
                <div class="d-flex flex-wrap gap-2">
                    {% for day in missing_days[:10] %}
                    <span class="badge bg-warning text-dark">{{ day.date.strftime('%d-%m-%Y') }}</span>
                    {% endfor %}
                    {% if missing_days|length > 10 %}
                    <span class="badge bg-secondary">+{{ missing_days|length - 10 }} more</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Transaction count chart
fetch('/api/transaction-chart?days=7')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('transactionChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.dates,
                datasets: [{
                    label: 'Transaction Count',
                    data: data.counts,
                    backgroundColor: 'rgba(9, 105, 218, 0.7)',
                    borderColor: 'rgba(9, 105, 218, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            callback: function(value) {
                                return value;
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Count: ' + context.parsed.y;
                            }
                        }
                    },
                    legend: {
                        display: false
                    }
                }
            }
        });
    });
</script>
{% endblock %}
